#!/usr/bin/env bash

DIR=$(realpath ${0%/*/*/*})

LOG=${2:((1+${#DIR}))}

mkdir -p /var/log/crontab/$(dirname $LOG)

cd $2
direnv allow

run="cd $2 && exec timeout 24h direnv exec . ./${@:3}"

job="$1 * * bash -c \"source /etc/profile && $run\" > /var/log/crontab/$LOG.log 2>&1"

crontab -l | (
  cat | grep -v -F "$run"
  echo "$job"
) | crontab -

echo -e "\033[32mcrontab added\033[0m"
echo -e "\n$job\n"

